"use strict";(self.webpackChunk_kne_components_react_fetch=self.webpackChunk_kne_components_react_fetch||[]).push([[830],{71830:(e,t,a)=>{a.r(t),a.d(t,{Cache:()=>q,createWithFetch:()=>M,default:()=>N,getAjax:()=>x,getCache:()=>y,preset:()=>b,request:()=>T,useFetch:()=>L,withFetch:()=>D});var r=a(94922),n=a.n(r),o=a(10238),s=a.n(o),c=a(26938),u=a.n(c),i=a(64755),l=a.n(i),p=a(13665),d=a.n(p),h=a(33227),m=a.n(h);function g(){return g=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)({}).hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},g.apply(null,arguments)}function f(e,t){if(null==e)return{};var a={};for(var r in e)if({}.hasOwnProperty.call(e,r)){if(t.includes(r))continue;a[r]=e[r]}return a}const C=["options","urlParams"];var S={id:"params",plugin:(e,t)=>{let{options:a,url:r,method:n,params:o,data:s}=e;const c=t.componentContext.getProps(),{options:i,urlParams:p}=c,d=f(c,C),h=l()({},i,u()(d,["url","method","params","data"]),a,{url:r,method:n,params:o,data:s,urlParams:p}),m=Object.assign({},h);return"object"===typeof p&&Object.keys(p).length>0&&"string"===typeof m.url&&(m.url=m.url.replace(/{([\s\S]+?)}/g,((e,t)=>p.hasOwnProperty(t)?p[t]:e))),t.componentContext.setRequestParams(h),m}};const k=["isLocal"];class q{static now(){return(new Date).getTime()}constructor(e){const{ttl:t,maxLength:a,isLocal:r,localName:n}=Object.assign({},e);this.ttl=t||0,this.data={},this.cacheNameMapping={},this.maxLength=a||1e3,this.isLocal=!!n||r,this.localName=n,this._load()}_load(){if(this.isLocal)try{const e=window.localStorage&&window.localStorage.getItem(this.localName||q.KEY_NAME);if(!e)return;const t=JSON.parse(e);Object.keys(t).forEach((e=>{t[e].isLocal=!0})),this.data=t}catch(e){}}_save(){if(!this.isLocal)return;const e=Object.keys(this.data);Promise.all(e.map((e=>this.data[e].value))).then((e=>{const t={};Object.keys(this.data).forEach(((a,r)=>{const n=this.data[a],{isLocal:o}=n,s=f(n,k);!0===o&&(t[a]=Object.assign({},s,{value:e[r]}))})),window.localStorage&&window.localStorage.setItem(this.localName||q.KEY_NAME,JSON.stringify(t))}))}get(e){const t=this.data[e];let a=null;return t&&(a=t.value,t.expires&&q.now()>=t.expires&&(a=null,delete this.data[e])),this._save(),a}delByCacheName(e){this.cacheNameMapping[e]&&(this.cacheNameMapping[e].forEach((e=>{this.del(e)})),this.cacheNameMapping[e].clear())}del(e){const t=this.get(e);return delete this.data[e],this._save(),t}put(e,t,a){let{ttl:r,isLocal:n,cacheName:o}=a;void 0===r&&(r=this.ttl);let s=this.del(e);if(null!==t){const a=Object.keys(this.data);if(a.length>=this.maxLength){const e=a.sort(((e,t)=>this.data[e].createTime-this.data[t].createTime))[0];delete this.data[e]}const s=q.now();this.data[e]={expires:0===r?null:s+r,value:t,createTime:s,isLocal:n},o&&!this.cacheNameMapping[o]&&(this.cacheNameMapping[o]=new Set),o&&this.cacheNameMapping[o].add(e)}return this._save(),s}clean(){this.data={},this._save()}}q.KEY_NAME="REACT_FETCH_CACHE";const P={cache:new q({ttl:6e5,maxLength:1e3,isLocal:!0}),ajax:()=>{throw new Error("\u9ed8\u8ba4\u7684axios\u914d\u7f6e\u5df2\u7ecf\u79fb\u9664\uff0c\u8bf7\u9996\u5148\u5728preset\u91cc\u9762\u914d\u7f6e")},loading:null,error:null,empty:null,pagination:{initCurrent:1,pageSize:10,transform:e=>e},transformResponse:e=>{const{data:t}=e;return e.data={code:t.code,msg:t.msg,results:t.results},e}},y=()=>P.cache,x=()=>P.ajax;var b=e=>Object.assign(P,e),R={id:"cache-record",plugin:(e,t)=>{const{cache:a,isLocal:r,ttl:n}=t.componentContext.getProps(),o=!0===a?"":a,s=o+t.componentContext.getRequestToken();a&&(t.outputStack.request||t.outputStack.loader)&&void 0!==t.outputStack["output-data"]&&P.cache.put(s,t.outputStack.request||t.outputStack.loader,{ttl:n,isLocal:r,cacheName:o})},dependencies:["cache","request","output-data"]},j={id:"output-data",plugin:(e,t)=>{const{options:a,onRequestSuccess:r,ignoreSuccessState:n,transformData:o}=t.componentContext.getProps();if(Object.keys(t.errorStack).length>0)return;const s=t.output.data;if(!0!==n&&200!==s.code){const e=new Error(s.msg);throw e.responseData=s,e}const c=(e=>"function"===typeof o?o(e,t.outputStack.params):e)((!0!==n?s.results:s)||{});return r&&r(c),c},dependencies:["request"]};const v=[{id:"start",plugin:(e,t)=>{let{type:a}=e;const{onRequestStart:r}=t.componentContext.getProps(),{setIsLoading:n,setIsComplete:o}=t.componentContext;r&&r(),"refresh"===a&&n(!0),o(!1)}},S,{id:"cache",plugin:(e,t)=>{let{force:a}=e;const{cache:r}=t.componentContext.getProps(),n=t.componentContext.getRequestToken();if(!0===a||!r)return;const o=(!0===r?"":r)+n,s=P.cache.get(o);return s?Promise.resolve(s):void 0}},{id:"loader",plugin:async(e,t)=>{const{loader:a}=t.componentContext.getProps();if("function"!==typeof a)return;if(t.outputStack.cache)return t.outputStack.cache;return{data:{code:200,results:await a(t.outputStack.params)}}},dependencies:["params"]},{id:"request",plugin:(e,t)=>{let{force:a}=e;if(t.outputStack.loader||t.errorStack.loader)return;if(t.outputStack.cache)return t.outputStack.cache;const r=t.componentContext.getRequestToken();t.componentContext.requestParams=t.outputStack.params;const{ajax:n}=t.componentContext.getProps(),o=!0!==a&&m()(t.globalContext.pendingRequest,r)||(n||P.ajax)(t.outputStack.params);return t.globalContext.pendingRequest=Object.assign({},t.globalContext.pendingRequest,{[r]:o}),o.then((e=>(delete t.globalContext.pendingRequest[r],e)))},dependencies:["params"]},{id:"transform-response",plugin:(e,t)=>{const{transformResponse:a,ignoreSuccessState:r,options:n}=t.componentContext.getProps(),o=t.outputStack.request;if(o)return!0===r?o:(a||P.transformResponse)(Object.assign({},o))},dependencies:["request"]},j,R,{id:"load-more",plugin:(e,t)=>{let{type:a,callback:r}=e;if("load-more"===a&&"function"===typeof r){const{fetchData:e}=t.componentContext.getState();return r(e,t.output)}},dependencies:["output-data"]},{id:"complete",plugin:(e,t)=>{let{type:a}=e;const{setIsLoading:r,setIsComplete:n,setFetchData:o}=t.componentContext;o(t.output),"refresh"===a&&r(!1),n(!0)}},{id:"error",plugin:(e,t)=>{const{onRequestError:a,onRequestComplete:r}=t.componentContext.getProps(),{setError:n}=t.componentContext;if(Object.keys(t.errorStack).length>0){const e=Object.values(t.errorStack).map((e=>e.message)).filter((e=>!!e)).join("\n");a&&a(Object.values(t.errorStack)),n(e||"\u8bf7\u6c42\u53d1\u751f\u9519\u8bef")}else n(null);r&&r(t)}}],w={},O=e=>async t=>{t=Object.assign({},t);const a=v,r={props:t,globalContext:w,componentContext:e,requestContext:{},outputStack:{},errorStack:{},runPath:[],output:null},{debug:n}=e.getProps();for(let e of a)try{if((e.dependencies||[]).find((e=>-1===r.runPath.indexOf(e))))continue;!0===n&&console.info("react-fetch:plugin-"+e.id+":start",r);const a=await e.plugin(t,r);!0===n&&console.info("react-fetch:plugin-"+e.id+":complete",a),r.outputStack[e.id]=a,r.output=void 0!==a?a:r.output,r.runPath.push(e.id)}catch(o){console.error(o),r.errorStack[e.id]=o}return r},E=e=>d()(u()(e,["url","params","method","data","urlParams","options"]),{algorithm:"md5",encoding:"base64"}),L=e=>{const t=Object.assign({auto:!0,updateType:"reload"},e),a=(0,r.useRef)(t);a.current=t;const[n,o]=(0,r.useState)(!1),[s,c]=(0,r.useState)(!1),[u,i]=(0,r.useState)(null),[l,p]=(0,r.useState)(null),[d,h]=(0,r.useState)({}),m=(0,r.useRef)({isLoading:n,isComplete:s,fetchData:u,error:l,requestParams:d});m.current={isLoading:n,isComplete:s,fetchData:u,error:l,requestParams:d};const g=E(t),f=(0,r.useRef)(g);f.current=g;const C=(0,r.useRef)();(0,r.useMemo)((()=>{C.current=O({getProps:()=>a.current,getRequestToken:()=>f.current,getState:()=>m.current,requestParams:d,setRequestParams:h,setFetchData:i,setError:p,setIsComplete:c,setIsLoading:o})}),[]);const S=function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return C.current(Object.assign({},e,{force:t}))},k=function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return C.current(Object.assign({},e,{force:t,type:"refresh"}))},q=function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return C.current(Object.assign({},e,{force:t,type:"reload"}))},P=function(e,t){let a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return C.current(Object.assign({},e,{force:a,callback:t,type:"load-more"}))},y=(0,r.useRef)({});return y.current={send:S,refresh:k,reload:q,loadMore:P,setData:i},(0,r.useEffect)((()=>{a.current.auto&&(m.current.isComplete?y.current.send({type:a.current.updateType},!1):y.current.refresh({},!1))}),[g]),{isLoading:n,isComplete:s,data:u,error:l,send:S,refresh:k,reload:q,loadMore:P,setData:i,requestParams:d}},_=["component","render","loading","isEmpty","empty","error"],N=(0,r.forwardRef)(((e,t)=>{let{component:a,render:o,loading:c,isEmpty:i,empty:l,error:p}=e,d=f(e,_);const{isLoading:h,isComplete:m,data:C,requestParams:S,error:k,send:q,refresh:y,reload:x,loadMore:b,setData:R}=L(d),j=["url","params","urlParams","method","data","cache","ttl","isLocal","auto","loader","options","updateType","onRequestError","onRequestSuccess","onRequestComplete","onRequestStart","debug","ajax","transformData","transformResponse"],v=s()(d,j),w=u()(d,j);if((0,r.useImperativeHandle)(t,(()=>({isLoading:h,isComplete:m,data:C,requestParams:S,error:k,send:q,refresh:y,reload:x,loadMore:b,setData:R}))),h)return void 0===c?P.loading:c;if(k){const e=void 0===p?P.error:p;return"function"===typeof e?e(k):e}if(!m&&!C)return null;if("function"===typeof i?i(C,S):!C)return void 0===l?P.empty:l;if(a){const e=a;return n().createElement(e,g({},v,{fetchProps:w,isComplete:m,data:C,refresh:y,reload:x,setData:R,loadMore:b,send:q,requestParams:S}))}if(o)return o(g({},v,{fetchProps:w,isComplete:m,data:C,refresh:y,reload:x,setData:R,loadMore:b,send:q,requestParams:S}));throw new Error("\u8bf7\u4f20\u5165component\u53c2\u6570\u6216\u8005render\u53c2\u6570")})),D=e=>(0,r.forwardRef)(((t,a)=>n().createElement(N,g({},t,{component:e,ref:a})))),M=e=>t=>{const a=D(t);return(0,r.forwardRef)(((t,r)=>n().createElement(a,g({},l()({},e,t),{ref:r}))))},I=["onRequestParamsChange","onRequestDataChange","onError","onIsCompleteChange","onIsLoadingChange"],T=e=>{const t=Object.assign({},e,{options:Object.assign({},null==e?void 0:e.options)},{type:"refresh",ignoreSuccessState:!0}),{onRequestParamsChange:a,onRequestDataChange:r,onError:n,onIsCompleteChange:o,onIsLoadingChange:s}=t,c=f(t,I);return O({getProps:()=>c,getRequestToken:()=>E(c),requestParams:{},setRequestParams:function(){return a&&a(...arguments)},setFetchData:function(){return r&&r(...arguments)},setError:function(){return n&&n(...arguments)},setIsComplete:function(){return o&&o(...arguments)},setIsLoading:function(){return s&&s(...arguments)}})({}).then((e=>{let{outputStack:t}=e;return t["transform-response"]}))}}}]);
//# sourceMappingURL=830.859f772b.chunk.js.map