"use strict";(self.webpackChunk_kne_components_react_fetch=self.webpackChunk_kne_components_react_fetch||[]).push([[208],{15648:(e,t,a)=>{a.r(t),a.d(t,{Cache:()=>x,createWithFetch:()=>N,default:()=>E,getCache:()=>y,preset:()=>q,useFetch:()=>j,withFetch:()=>L});var o=a(49256),r=a.n(o),n=a(5e4),s=a.n(n),c=a(35940),u=a.n(c),i=a(4808),l=a.n(i),p=a(39940),d=a.n(p),h=a(58564),m=a.n(h);function f(){return f=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(e[o]=a[o])}return e},f.apply(this,arguments)}function g(e,t){if(null==e)return{};var a,o,r={},n=Object.keys(e);for(o=0;o<n.length;o++)a=n[o],t.indexOf(a)>=0||(r[a]=e[a]);return r}const C=["options"];var k={id:"params",plugin:(e,t)=>{let{options:a,url:o,method:r,params:n,data:s}=e;const c=t.componentContext.getProps(),{options:i}=c,l=g(c,C),p=d()({},i,u()(l,["url","method","params","data"]),a,{url:o,method:r,params:n,data:s});return t.componentContext.setRequestParams(p),p}};const S=["isLocal"];class x{static now(){return(new Date).getTime()}constructor(e){const{ttl:t,maxLength:a,isLocal:o,localName:r}=Object.assign({},e);this.ttl=t||0,this.data={},this.cacheNameMapping={},this.maxLength=a||1e3,this.isLocal=!!r||o,this.localName=r,this._load()}_load(){if(this.isLocal)try{const e=window.localStorage&&window.localStorage.getItem(this.localName||x.KEY_NAME);if(!e)return;const t=JSON.parse(e);Object.keys(t).forEach((e=>{t[e].isLocal=!0})),this.data=t}catch(e){}}_save(){if(!this.isLocal)return;const e=Object.keys(this.data);Promise.all(e.map((e=>this.data[e].value))).then((e=>{const t={};Object.keys(this.data).forEach(((a,o)=>{const r=this.data[a],{isLocal:n}=r,s=g(r,S);!0===n&&(t[a]=Object.assign({},s,{value:e[o]}))})),window.localStorage&&window.localStorage.setItem(this.localName||x.KEY_NAME,JSON.stringify(t))}))}get(e){const t=this.data[e];let a=null;return t&&(a=t.value,t.expires&&x.now()>=t.expires&&(a=null,delete this.data[e])),this._save(),a}delByCacheName(e){this.cacheNameMapping[e]&&(this.cacheNameMapping[e].forEach((e=>{this.del(e)})),this.cacheNameMapping[e].clear())}del(e){const t=this.get(e);return delete this.data[e],this._save(),t}put(e,t,a){let{ttl:o,isLocal:r,cacheName:n}=a;void 0===o&&(o=this.ttl);let s=this.del(e);if(null!==t){const a=Object.keys(this.data);if(a.length>=this.maxLength){const e=a.sort(((e,t)=>this.data[e].createTime-this.data[t].createTime))[0];delete this.data[e]}const s=x.now();this.data[e]={expires:0===o?null:s+o,value:t,createTime:s,isLocal:r},n&&!this.cacheNameMapping[n]&&(this.cacheNameMapping[n]=new Set),n&&this.cacheNameMapping[n].add(e)}return this._save(),s}clean(){this.data={},this._save()}}x.KEY_NAME="REACT_FETCH_CACHE";const b={cache:new x({ttl:6e5,maxLength:1e3,isLocal:!0}),ajax:()=>{throw new Error("\u9ed8\u8ba4\u7684axios\u914d\u7f6e\u5df2\u7ecf\u79fb\u9664\uff0c\u8bf7\u9996\u5148\u5728preset\u91cc\u9762\u914d\u7f6e")},loading:null,error:null,empty:null,pagination:{initCurrent:1,pageSize:10,transform:e=>e},transformResponse:e=>{const{data:t}=e;return e.data={code:t.code,msg:t.msg,results:t.results},e}},y=()=>b.cache;var q=e=>Object.assign(b,e),v={id:"cache-record",plugin:(e,t)=>{const{cache:a,isLocal:o,ttl:r}=t.componentContext.getProps(),n=!0===a?"":a,s=n+t.componentContext.getRequestToken();a&&(t.outputStack.request||t.outputStack.loader)&&void 0!==t.outputStack["output-data"]&&b.cache.put(s,t.outputStack.request||t.outputStack.loader,{ttl:r,isLocal:o,cacheName:n})},dependencies:["cache","request","output-data"]},R={id:"output-data",plugin:(e,t)=>{const{onRequestSuccess:a,transformData:o}=t.componentContext.getProps();if(Object.keys(t.errorStack).length>0)return;const r=t.output.data;if(200!==r.code){const e=new Error(r.msg);throw e.responseData=r,e}const n=(e=>"function"===typeof o?o(e,t.outputStack.params):e)(r.results||{});return a&&a(n),n},dependencies:["request"]};const w=[{id:"start",plugin:(e,t)=>{let{type:a}=e;const{onRequestStart:o}=t.componentContext.getProps(),{setIsLoading:r,setIsComplete:n}=t.componentContext;o&&o(),"refresh"===a&&r(!0),n(!1)}},k,{id:"cache",plugin:(e,t)=>{let{force:a}=e;const{cache:o}=t.componentContext.getProps(),r=t.componentContext.getRequestToken();if(!0===a||!o)return;const n=(!0===o?"":o)+r,s=b.cache.get(n);return s?Promise.resolve(s):void 0}},{id:"loader",plugin:async(e,t)=>{const{loader:a}=t.componentContext.getProps();if("function"!==typeof a)return;if(t.outputStack.cache)return t.outputStack.cache;return{data:{code:200,results:await a(t.outputStack.params)}}},dependencies:["params"]},{id:"request",plugin:(e,t)=>{let{force:a}=e;if(t.outputStack.loader||t.errorStack.loader)return;if(t.outputStack.cache)return t.outputStack.cache;const o=t.componentContext.getRequestToken();t.componentContext.requestParams=t.outputStack.params;const{ajax:r}=t.componentContext.getProps(),n=!0!==a&&m()(t.globalContext.pendingRequest,o)||(r||b.ajax)(t.outputStack.params);return t.globalContext.pendingRequest=Object.assign({},t.globalContext.pendingRequest,{[o]:n}),n.then((e=>(delete t.globalContext.pendingRequest[o],e)))},dependencies:["params"]},{id:"transform-response",plugin:(e,t)=>{const{transformResponse:a}=t.componentContext.getProps(),o=t.outputStack.request;if(o)return(a||b.transformResponse)(Object.assign({},o))},dependencies:["request"]},R,v,{id:"load-more",plugin:(e,t)=>{let{type:a,callback:o}=e;const{fetchData:r}=t.componentContext.getState();if("load-more"===a&&"function"===typeof o)return o(r,t.output)},dependencies:["output-data"]},{id:"complete",plugin:(e,t)=>{let{type:a}=e;const{setIsLoading:o,setIsComplete:r,setFetchData:n}=t.componentContext;n(t.output),"refresh"===a&&o(!1),r(!0)}},{id:"error",plugin:(e,t)=>{const{onRequestError:a,onRequestComplete:o}=t.componentContext.getProps(),{setError:r}=t.componentContext;if(Object.keys(t.errorStack).length>0){const e=Object.values(t.errorStack).map((e=>e.message)).filter((e=>!!e)).join("\n");a&&a(Object.values(t.errorStack)),r(e||"\u8bf7\u6c42\u53d1\u751f\u9519\u8bef")}else r(null);o&&o(t)}}],P={},j=e=>{const t=Object.assign({auto:!0,updateType:"reload"},e),a=(0,o.useRef)(t);a.current=t;const[r,n]=(0,o.useState)(!1),[s,c]=(0,o.useState)(!1),[i,p]=(0,o.useState)(null),[d,h]=(0,o.useState)(null),[m,f]=(0,o.useState)({}),g=(0,o.useRef)({isLoading:r,isComplete:s,fetchData:i,error:d,requestParams:m});g.current={isLoading:r,isComplete:s,fetchData:i,error:d,requestParams:m};const C=l()(u()(t,["url","params","method","data","options"]),{algorithm:"md5",encoding:"base64"}),k=(0,o.useRef)(C);k.current=C;const S=(0,o.useRef)();(0,o.useMemo)((()=>{var e;S.current=(e={getProps:()=>a.current,getRequestToken:()=>k.current,getState:()=>g.current,requestParams:m,setRequestParams:f,setFetchData:p,setError:h,setIsComplete:c,setIsLoading:n},async t=>{const a=w,o={props:t,globalContext:P,componentContext:e,requestContext:{},outputStack:{},errorStack:{},runPath:[],output:null},{debug:r}=e.getProps();for(let e of a)try{if((e.dependencies||[]).find((e=>-1===o.runPath.indexOf(e))))continue;!0===r&&console.info("react-fetch:plugin-"+e.id+":start",o);const a=await e.plugin(t,o);!0===r&&console.info("react-fetch:plugin-"+e.id+":complete",a),o.outputStack[e.id]=a,o.output=void 0!==a?a:o.output,o.runPath.push(e.id)}catch(n){console.error(n),o.errorStack[e.id]=n}return o})}),[]);const x=function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return S.current(Object.assign({},e,{force:t}))},b=function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return S.current(Object.assign({},e,{force:t,type:"refresh"}))},y=function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return S.current(Object.assign({},e,{force:t,type:"reload"}))},q=function(e,t){let a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return S.current(Object.assign({},e,{force:a,callback:t,type:"load-more"}))},v=(0,o.useRef)({});return v.current={send:x,refresh:b,reload:y,loadMore:q,setData:p},(0,o.useEffect)((()=>{a.current.auto&&(g.current.isComplete?v.current.send({type:a.current.updateType},!1):v.current.refresh({},!1))}),[C]),{isLoading:r,isComplete:s,data:i,error:d,send:x,refresh:b,reload:y,loadMore:q,setData:p,requestParams:m}},O=["component","render","loading","isEmpty","empty","error"],E=(0,o.forwardRef)(((e,t)=>{let{component:a,render:n,loading:c,isEmpty:i,empty:l,error:p}=e,d=g(e,O);const{isLoading:h,isComplete:m,data:C,requestParams:k,error:S,send:x,refresh:y,reload:q,loadMore:v,setData:R}=j(d),w=["url","params","method","data","cache","ttl","isLocal","auto","loader","options","updateType","onRequestError","onRequestSuccess","onRequestComplete","onRequestStart","debug","ajax","transformData","transformResponse"],P=s()(d,w),E=u()(d,w);if((0,o.useImperativeHandle)(t,(()=>({isLoading:h,isComplete:m,data:C,requestParams:k,error:S,send:x,refresh:y,reload:q,loadMore:v,setData:R}))),h)return void 0===c?b.loading:c;if(S){const e=void 0===p?b.error:p;return"function"===typeof e?e(S):e}if(!m&&!C)return null;if("function"===typeof i?i(C,k):!C)return void 0===l?b.empty:l;if(a){const e=a;return r().createElement(e,f({},P,{fetchProps:E,isComplete:m,data:C,refresh:y,reload:q,setData:R,loadMore:v,send:x,requestParams:k}))}if(n)return n(f({},P,{fetchProps:E,isComplete:m,data:C,refresh:y,reload:q,setData:R,loadMore:v,send:x,requestParams:k}));throw new Error("\u8bf7\u4f20\u5165component\u53c2\u6570\u6216\u8005render\u53c2\u6570")})),L=e=>(0,o.forwardRef)(((t,a)=>r().createElement(E,f({},t,{component:e,ref:a})))),N=e=>t=>{const a=L(t);return(0,o.forwardRef)(((t,o)=>r().createElement(a,f({},d()({},e,t),{ref:o}))))}},47624:(e,t,a)=>{a.r(t),a.d(t,{default:()=>o,manifest:()=>r});const o={ReactFetch:a(56088).c},r={name:"react-fetch",version:"1.4.3","open-version":!0,"public-url":"/react-fetch",modules:[{name:"react-fetch",baseDir:"/home/runner/work/react-fetch/react-fetch",description:"\u7528\u4e8e\u83b7\u53d6\u6570\u636e\u7684react\u7ec4\u4ef6",packageName:"@kne/react-fetch"}]}}}]);
//# sourceMappingURL=208.081be909.chunk.js.map